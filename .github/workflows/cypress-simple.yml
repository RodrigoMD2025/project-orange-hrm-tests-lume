name: 🧪 Cypress Tests (Simple)

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  cypress-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, electron]  # Electron é mais estável no CI
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        
      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: 📦 Install Dependencies
        run: npm ci
        
      - name: 🧪 Run Cypress Tests
        run: |
          if [ "${{ matrix.browser }}" = "electron" ]; then
            npx cypress run
          else
            npx cypress run --browser ${{ matrix.browser }}
          fi
        env:
          CYPRESS_baseUrl: https://opensource-demo.orangehrmlive.com/web/index.php
          
      - name: 📊 Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports-${{ matrix.browser }}
          path: cypress/reports/
          retention-days: 30
          if-no-files-found: ignore
          
      - name: 🎥 Upload Test Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos-${{ matrix.browser }}
          path: cypress/videos/
          retention-days: 7
          if-no-files-found: ignore
          
      - name: 📸 Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots-${{ matrix.browser }}
          path: cypress/screenshots/
          retention-days: 14
          if-no-files-found: ignore
          
      - name: 📋 Test Results Summary
        if: always()
        run: |
          echo "## 🧪 Cypress Test Results - ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | ${{ matrix.browser }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.head_ref || github.ref_name }} |" >> $GITHUB_STEP_SUMMARY

  # Job para consolidar resultados
  test-summary:
    if: always()
    needs: cypress-test
    runs-on: ubuntu-latest
    steps:
      - name: 📈 Final Test Summary
        run: |
          echo "## 🎯 Resumo Final da Execução" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Estatísticas:" >> $GITHUB_STEP_SUMMARY
          echo "- **Data**: $(date +'%d/%m/%Y %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Browsers Testados**: Chrome, Electron" >> $GITHUB_STEP_SUMMARY
          echo "- **Total de Specs**: 3 (admin, timesheet, user)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total de Testes**: 20" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.cypress-test.result }}" == "success" ]]; then
            echo "### ✅ Status: TODOS OS TESTES PASSARAM!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "🎉 Parabéns! Todos os 20 testes foram executados com sucesso." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ⚠️ Status: CONFIGURAÇÃO INICIAL NECESSÁRIA" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "🔧 Configure o Cypress Cloud (opcional) ou use o workflow simples." >> $GITHUB_STEP_SUMMARY
          fi
