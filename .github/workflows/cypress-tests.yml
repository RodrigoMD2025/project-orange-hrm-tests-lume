name: ðŸ§ª Cypress E2E Tests - OrangeHRM

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:  # Permite execuÃ§Ã£o manual
  schedule:
    - cron: '0 2 * * 1-5'  # ExecuÃ§Ã£o diÃ¡ria Ã s 2h (segunda a sexta)

env:
  NODE_VERSION: '22'  # Alinhado com a versÃ£o local do projeto

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout para evitar execuÃ§Ãµes infinitas
    
    strategy:
      fail-fast: false  # Continua outros jobs mesmo se um falhar
      matrix:
        browser: [chrome, firefox]  # Testa em mÃºltiplos browsers
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'  # Cache das dependÃªncias para execuÃ§Ã£o mais rÃ¡pida
          
      - name: ðŸ“¦ Install Dependencies
        run: npm ci  # InstalaÃ§Ã£o mais rÃ¡pida e determinÃ­stica
        
      - name: ðŸ§ª Run Cypress Tests (${{ matrix.browser }})
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ matrix.browser }}
          headless: true
          record: true
          parallel: true
          group: 'GitHub Actions - ${{ matrix.browser }}'
          tag: 'github-actions'
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # VariÃ¡veis para identificaÃ§Ã£o no Cypress Cloud
          COMMIT_INFO_BRANCH: ${{ github.head_ref || github.ref_name }}
          COMMIT_INFO_SHA: ${{ github.sha }}
          COMMIT_INFO_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        continue-on-error: false
          
      - name: ðŸ“Š Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports-${{ matrix.browser }}
          path: cypress/reports/
          retention-days: 30
          
      - name: ðŸŽ¥ Upload Test Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos-${{ matrix.browser }}
          path: cypress/videos/
          retention-days: 7
          
      - name: ðŸ“¸ Upload Screenshots (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots-${{ matrix.browser }}
          path: cypress/screenshots/
          retention-days: 14
          
      - name: ðŸ“‹ Test Results Summary
        if: always()
        run: |
          echo "## ðŸ§ª Cypress Test Results - ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | ${{ matrix.browser }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  # Job para consolidar resultados e notificar
  test-results:
    if: always()
    needs: cypress-run
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Consolidate Test Results
        run: |
          echo "## ðŸ“ˆ Resumo Geral dos Testes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Detalhes da ExecuÃ§Ã£o:" >> $GITHUB_STEP_SUMMARY
          echo "- **Data**: $(date +'%d/%m/%Y %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Browsers**: Chrome, Firefox" >> $GITHUB_STEP_SUMMARY
          echo "- **Total de Specs**: 3 (admin, timesheet, user)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total de Testes**: 20" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.cypress-run.result }}" == "success" ]]; then
            echo "### âœ… Status: TODOS OS TESTES PASSARAM!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ ParabÃ©ns! Todos os 20 testes foram executados com sucesso em ambos os browsers." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: FALHAS DETECTADAS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš« Alguns testes falharam. Verifique os logs e screenshots para detalhes." >> $GITHUB_STEP_SUMMARY
          fi
